<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>益智题挑战</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937',
                        light: '#F3F4F6',
                        types: {
                            math: '#3B82F6',
                            logic: '#EC4899',
                            trivia: '#10B981',
                            word: '#8B5CF6',
                            life: '#F59E0B',
                            fun: '#6366F1',
                            number: '#F97316'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .question-card {
                transition: all 0.5s ease;
            }
            .question-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            }
            .scale-in {
                animation: scaleIn 0.5s ease forwards;
            }
            @keyframes scaleIn {
                0% { transform: scale(0.95); opacity: 0; }
                100% { transform: scale(1); opacity: 1; }
            }
            .fade-in {
                animation: fadeIn 0.5s ease forwards;
            }
            @keyframes fadeIn {
                0% { opacity: 0; }
                100% { opacity: 1; }
            }
        }
    </style>
    <style>
        @media (max-width: 640px) {
            html {
                font-size: 14px;
            }
            
            .container {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
            
            #game-container {
                padding: 1.5rem !important;
            }
            
            .btn-mobile {
                padding: 0.75rem 1.5rem !important;
                font-size: 1rem !important;
            }
            
            #question {
                font-size: 1.75rem !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen font-inter text-dark">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- 加载提示 -->
        <div id="loading-indicator" class="text-center py-10">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
            <p class="text-gray-600">正在加载题库，请稍候...</p>
        </div>

        <!-- 游戏标题 -->
        <header class="text-center mb-6 hidden" id="game-header">
            <h1 class="text-[clamp(1.5rem,4vw,2.5rem)] font-bold text-primary mb-2 text-shadow">益智题挑战</h1>
            <p class="text-gray-600">测试你的综合能力，挑战各类益智题目！</p>
        </header>

        <!-- 游戏状态 -->
        <div class="flex flex-wrap gap-3 justify-center mb-6 hidden" id="game-stats">
            <div class="bg-white rounded-xl shadow-lg p-3 w-[45%] flex items-center justify-center card-hover">
                <i class="fa fa-trophy text-accent text-xl mr-2"></i>
                <div>
                    <p class="text-gray-500 text-xs">得分</p>
                    <p id="score" class="text-xl font-bold">0</p>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-3 w-[45%] flex items-center justify-center card-hover">
                <i class="fa fa-clock-o text-danger text-xl mr-2"></i>
                <div>
                    <p class="text-gray-500 text-xs">剩余时间</p>
                    <p id="timer" class="text-xl font-bold">60</p>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-3 w-[45%] flex items-center justify-center card-hover">
                <i class="fa fa-signal text-secondary text-xl mr-2"></i>
                <div>
                    <p class="text-gray-500 text-xs">难度</p>
                    <p id="difficulty" class="text-xl font-bold">简单</p>
                </div>
            </div>
            
            <div id="question-type-indicator" class="bg-white rounded-xl shadow-lg p-3 w-[45%] flex items-center justify-center card-hover">
                <i id="type-icon" class="fa fa-calculator text-types-math text-xl mr-2"></i>
                <div>
                    <p class="text-gray-500 text-xs">题目类型</p>
                    <p id="question-type" class="text-xl font-bold">数学运算</p>
                </div>
            </div>
        </div>

        <!-- 游戏区域 -->
        <div id="game-container" class="bg-white rounded-2xl shadow-xl p-6 mb-6 transform transition-all duration-500 question-card hidden">
            <div id="question-container" class="text-center mb-6">
                <p class="text-gray-600 mb-2">当前题目</p>
                <p id="question" class="text-2xl md:text-3xl font-bold mb-4">3 + 5 = ?</p>
                
                <div id="options-container" class="flex flex-col sm:flex-row gap-3 justify-center mb-6">
                    <button id="option1" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg btn-mobile">8</button>
                    <button id="option2" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg btn-mobile">9</button>
                    <button id="option3" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg btn-mobile">7</button>
                </div>
                
                <div id="input-answer-container" class="hidden mb-6">
                    <input type="text" id="input-answer" placeholder="输入你的答案..." class="w-full max-w-md mx-auto px-4 py-2 rounded-lg border-2 border-gray-300 focus:border-primary focus:ring focus:ring-primary/20 outline-none transition-all">
                    <button id="submit-answer" class="mt-3 bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg btn-mobile">
                        提交答案
                    </button>
                </div>
            </div>
            
            <div id="feedback" class="text-center h-8 mb-3"></div>
            
            <div id="progress-container" class="h-3 w-full bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-secondary to-primary transition-all duration-300" style="width: 100%"></div>
            </div>
        </div>

        <!-- 游戏控制 -->
        <div class="flex flex-wrap gap-3 justify-center mb-6 hidden" id="game-controls">
            <button id="start-btn" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-secondary/50 shadow-lg btn-mobile">
                <i class="fa fa-play mr-2"></i>开始游戏
            </button>
            <button id="restart-btn" class="bg-accent hover:bg-accent/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-accent/50 shadow-lg hidden btn-mobile">
                <i class="fa fa-refresh mr-2"></i>重新开始
            </button>
            <button id="settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500/50 shadow-lg btn-mobile">
                <i class="fa fa-cog mr-2"></i>设置
            </button>
            <button id="leaderboard-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg btn-mobile">
                <i class="fa fa-list-ol mr-2"></i>排行榜
            </button>
        </div>

        <!-- 设置模态框 -->
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-5 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-primary">游戏设置</h2>
                    <button id="close-settings" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 font-medium">题目类型</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <label class="flex items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <input type="checkbox" name="question-types" value="math" checked class="mr-2 h-4 w-4 text-types-math focus:ring-types-math rounded">
                            <span class="flex items-center">
                                <i class="fa fa-calculator text-types-math mr-2"></i>
                                数学运算
                            </span>
                        </label>
                        <label class="flex items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <input type="checkbox" name="question-types" value="logic" checked class="mr-2 h-4 w-4 text-types-logic focus:ring-types-logic rounded">
                            <span class="flex items-center">
                                <i class="fa fa-puzzle-piece text-types-logic mr-2"></i>
                                逻辑思维
                            </span>
                        </label>
                        <label class="flex items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <input type="checkbox" name="question-types" value="trivia" checked class="mr-2 h-4 w-4 text-types-trivia focus:ring-types-trivia rounded">
                            <span class="flex items-center">
                                <i class="fa fa-lightbulb-o text-types-trivia mr-2"></i>
                                脑筋急转弯
                            </span>
                        </label>
                        <label class="flex items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <input type="checkbox" name="question-types" value="word" checked class="mr-2 h-4 w-4 text-types-word focus:ring-types-word rounded">
                            <span class="flex items-center">
                                <i class="fa fa-book text-types-word mr-2"></i>
                                文字理解
                            </span>
                        </label>
                        <label class="flex items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <input type="checkbox" name="question-types" value="life" checked class="mr-2 h-4 w-4 text-types-life focus:ring-types-life rounded">
                            <span class="flex items-center">
                                <i class="fa fa-home text-types-life mr-2"></i>
                                生活常识
                            </span>
                        </label>
                        <label class="flex items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <input type="checkbox" name="question-types" value="fun" checked class="mr-2 h-4 w-4 text-types-fun focus:ring-types-fun rounded">
                            <span class="flex items-center">
                                <i class="fa fa-smile-o text-types-fun mr-2"></i>
                                趣味推理
                            </span>
                        </label>
                        <label class="flex items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <input type="checkbox" name="question-types" value="number" checked class="mr-2 h-4 w-4 text-types-number focus:ring-types-number rounded">
                            <span class="flex items-center">
                                <i class="fa fa-superscript text-types-number mr-2"></i>
                                数字推理
                            </span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="time-limit" class="block text-gray-700 mb-2 font-medium">每题时间限制 (秒)</label>
                    <input type="range" id="time-limit" min="5" max="120" value="60" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                    <div class="flex justify-between text-sm text-gray-500 mt-1">
                        <span>5秒</span>
                        <span id="time-value">60秒</span>
                        <span>120秒</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="difficulty-setting" class="block text-gray-700 mb-2 font-medium">难度级别</label>
                    <select id="difficulty-setting" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        <option value="easy">简单</option>
                        <option value="medium">中等</option>
                        <option value="hard">困难</option>
                    </select>
                </div>
                
                <div class="flex justify-end">
                    <button id="save-settings" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-5 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg">
                        保存设置
                    </button>
                </div>
            </div>
        </div>

        <!-- 游戏结束模态框 -->
        <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-5 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="game-over-content">
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-accent/20 mb-3">
                        <i class="fa fa-trophy text-accent text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-primary mb-2">游戏结束!</h2>
                    <p class="text-gray-600">你的表现很棒!</p>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2 p-2 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">最终得分</span>
                        <span id="final-score" class="text-xl font-bold text-primary">0</span>
                    </div>
                    <div class="flex justify-between items-center mb-2 p-2 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">答对题目</span>
                        <span id="correct-answers" class="text-lg font-bold text-secondary">0</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">答错题目</span>
                        <span id="wrong-answers" class="text-lg font-bold text-danger">0</span>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button id="play-again" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-5 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg">
                        <i class="fa fa-refresh mr-2"></i>再玩一次
                    </button>
                    <button id="share-result" class="bg-accent hover:bg-accent/90 text-white font-bold py-2 px-5 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-accent/50 shadow-lg">
                        <i class="fa fa-share-alt mr-2"></i>分享结果
                    </button>
                </div>
            </div>
        </div>

        <!-- 玩家名称输入模态框 -->
        <div id="player-name-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-5 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="name-modal-content">
                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold text-primary">输入你的名字</h2>
                    <p class="text-gray-600">以便记录你的精彩成绩</p>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="player-name" placeholder="请输入你的名字..." class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-primary focus:ring focus:ring-primary/20 outline-none transition-all" maxlength="15">
                    <p class="text-gray-500 text-sm mt-1 text-right">最多15个字符</p>
                </div>
                
                <div class="flex justify-center">
                    <button id="save-name-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg">
                        保存
                    </button>
                </div>
            </div>
        </div>

        <!-- 排行榜模态框 -->
        <div id="leaderboard-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-5 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="leaderboard-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-primary">得分排行榜</h2>
                    <button id="close-leaderboard" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4 max-h-96 overflow-y-auto pr-2">
                    <div id="leaderboard-list" class="space-y-2">
                        <!-- 排行榜内容将通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="flex justify-center">
                    <button id="clear-leaderboard" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500/50 shadow-lg">
                        <i class="fa fa-trash mr-2"></i>清空记录
                    </button>
                </div>
            </div>
        </div>

        <!-- 加载错误提示 -->
        <div id="load-error" class="text-center py-10 hidden">
            <div class="inline-block text-danger text-4xl mb-4">
                <i class="fa fa-exclamation-circle"></i>
            </div>
            <p class="text-gray-600 mb-4">题库加载失败</p>
            <button id="retry-load" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg">
                重试加载
            </button>
        </div>

        <!-- 页脚 -->
        <footer class="text-center text-gray-500 mt-8 text-sm hidden" id="footer">
            <p>© 2025 益智题挑战 | 训练你的大脑</p>
        </footer>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            score: 0,
            timeLeft: 60,
            timerInterval: null,
            isPlaying: false,
            currentQuestion: null,
            correctAnswers: 0,
            wrongAnswers: 0,
            difficulty: 'easy',
            questionTypes: ['math', 'logic', 'trivia', 'word', 'life', 'fun', 'number'],
            timeLimit: 60,
            questions: null, // 从JSON加载的题库
            usedQuestions: {} // 记录已使用的题目索引，避免重复
        };

        // 题目类型配置
        const questionTypeConfig = {
            math: {
                name: '数学运算',
                icon: 'fa-calculator',
                color: 'text-types-math',
                buttonColor: 'bg-types-math'
            },
            logic: {
                name: '逻辑思维',
                icon: 'fa-puzzle-piece',
                color: 'text-types-logic',
                buttonColor: 'bg-types-logic'
            },
            trivia: {
                name: '脑筋急转弯',
                icon: 'fa-lightbulb-o',
                color: 'text-types-trivia',
                buttonColor: 'bg-types-trivia'
            },
            word: {
                name: '文字理解',
                icon: 'fa-book',
                color: 'text-types-word',
                buttonColor: 'bg-types-word'
            },
            life: {
                name: '生活常识',
                icon: 'fa-home',
                color: 'text-types-life',
                buttonColor: 'bg-types-life'
            },
            fun: {
                name: '趣味推理',
                icon: 'fa-smile-o',
                color: 'text-types-fun',
                buttonColor: 'bg-types-fun'
            },
            number: {
                name: '数字推理',
                icon: 'fa-superscript',
                color: 'text-types-number',
                buttonColor: 'bg-types-number'
            }
        };

        // 排行榜相关游戏状态
        const leaderboardState = {
            playerName: localStorage.getItem('puzzleGamePlayerName') || '',
            scores: JSON.parse(localStorage.getItem('puzzleGameScores')) || []
        };

        // DOM 元素
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings');
        const saveSettingsBtn = document.getElementById('save-settings');
        const playAgainBtn = document.getElementById('play-again');
        const shareResultBtn = document.getElementById('share-result');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const difficultyDisplay = document.getElementById('difficulty');
        const questionDisplay = document.getElementById('question');
        const optionButtons = [
            document.getElementById('option1'),
            document.getElementById('option2'),
            document.getElementById('option3')
        ];
        const optionsContainer = document.getElementById('options-container');
        const inputAnswerContainer = document.getElementById('input-answer-container');
        const inputAnswer = document.getElementById('input-answer');
        const submitAnswer = document.getElementById('submit-answer');
        const feedbackDisplay = document.getElementById('feedback');
        const progressBar = document.getElementById('progress-bar');
        const gameContainer = document.getElementById('game-container');
        const settingsModal = document.getElementById('settings-modal');
        const modalContent = document.getElementById('modal-content');
        const gameOverModal = document.getElementById('game-over-modal');
        const gameOverContent = document.getElementById('game-over-content');
        const finalScoreDisplay = document.getElementById('final-score');
        const correctAnswersDisplay = document.getElementById('correct-answers');
        const wrongAnswersDisplay = document.getElementById('wrong-answers');
        const timeLimitSlider = document.getElementById('time-limit');
        const timeValueDisplay = document.getElementById('time-value');
        const difficultySetting = document.getElementById('difficulty-setting');
        const questionTypeCheckboxes = document.querySelectorAll('input[name="question-types"]');
        const questionTypeIndicator = document.getElementById('question-type-indicator');
        const questionTypeDisplay = document.getElementById('question-type');
        const typeIcon = document.getElementById('type-icon');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadError = document.getElementById('load-error');
        const retryLoadBtn = document.getElementById('retry-load');
        const gameHeader = document.getElementById('game-header');
        const gameStats = document.getElementById('game-stats');
        const gameControls = document.getElementById('game-controls');
        const footer = document.getElementById('footer');
        
        // 新增DOM元素
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const closeLeaderboardBtn = document.getElementById('close-leaderboard');
        const leaderboardList = document.getElementById('leaderboard-list');
        const clearLeaderboardBtn = document.getElementById('clear-leaderboard');
        const playerNameModal = document.getElementById('player-name-modal');
        const nameModalContent = document.getElementById('name-modal-content');
        const playerNameInput = document.getElementById('player-name');
        const saveNameBtn = document.getElementById('save-name-btn');

        // 初始化事件监听器
        function initEventListeners() {
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', restartGame);
            settingsBtn.addEventListener('click', openSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);
            saveSettingsBtn.addEventListener('click', saveSettings);
            playAgainBtn.addEventListener('click', restartGame);
            shareResultBtn.addEventListener('click', shareResult);
            timeLimitSlider.addEventListener('input', updateTimeValue);
            optionButtons.forEach(button => button.addEventListener('click', checkAnswer));
            submitAnswer.addEventListener('click', checkInputAnswer);
            retryLoadBtn.addEventListener('click', loadQuestions);
            
            // 允许按Enter键提交输入答案
            inputAnswer.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkInputAnswer();
                }
            });
            
            // 模态框点击外部关闭
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeSettings();
            });
            
            gameOverModal.addEventListener('click', (e) => {
                if (e.target === gameOverModal) closeGameOverModal();
            });
            
            // 初始化排行榜事件监听器
            initLeaderboardEventListeners();
        }

        // 初始化排行榜事件监听器
        function initLeaderboardEventListeners() {
            leaderboardBtn.addEventListener('click', openLeaderboard);
            closeLeaderboardBtn.addEventListener('click', closeLeaderboard);
            clearLeaderboardBtn.addEventListener('click', clearLeaderboard);
            saveNameBtn.addEventListener('click', savePlayerName);
            
            // 玩家名称输入框按Enter键保存
            playerNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    savePlayerName();
                }
            });
            
            // 点击模态框外部关闭
            leaderboardModal.addEventListener('click', (e) => {
                if (e.target === leaderboardModal) closeLeaderboard();
            });
            
            playerNameModal.addEventListener('click', (e) => {
                if (e.target === playerNameModal) closePlayerNameModal();
            });
        }

        // 显示游戏界面
        function showGameUI() {
            loadingIndicator.classList.add('hidden');
            loadError.classList.add('hidden');
            gameHeader.classList.remove('hidden');
            gameStats.classList.remove('hidden');
            gameControls.classList.remove('hidden');
            gameContainer.classList.remove('hidden');
            footer.classList.remove('hidden');
        }

        // 显示加载错误
        function showLoadError() {
            loadingIndicator.classList.add('hidden');
            loadError.classList.remove('hidden');
        }

        // 加载题库
        async function loadQuestions() {
            loadingIndicator.classList.remove('hidden');
            loadError.classList.add('hidden');
            
            try {
                // 检查文件路径是否正确
                const response = await fetch('questions.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                // 适配新的JSON结构
                gameState.questions = {};
                for (const [key, value] of Object.entries(data)) {
                    gameState.questions[key] = value.questions || value;
                }
                
                console.log('题库加载成功');
                showGameUI();
            } catch (error) {
                console.error('加载题库时出错:', error);
                showLoadError();
            }
        }

        // 更新时间显示
        function updateTimeValue() {
            timeValueDisplay.textContent = `${timeLimitSlider.value}秒`;
        }

        // 开始游戏
        function startGame() {
            if (!gameState.questions) {
                alert('题库未加载完成，请稍候重试');
                return;
            }
            
            gameState.isPlaying = true;
            startBtn.classList.add('hidden');
            restartBtn.classList.remove('hidden');
            gameState.score = 0;
            gameState.correctAnswers = 0;
            gameState.wrongAnswers = 0;
            updateScore();
            generateQuestion();
            startTimer();
            
            // 添加游戏开始动画
            gameContainer.classList.add('animate-pulse');
            setTimeout(() => {
                gameContainer.classList.remove('animate-pulse');
            }, 1000);
        }

        // 重新开始游戏
        function restartGame() {
            clearInterval(gameState.timerInterval);
            gameState.timeLeft = gameState.timeLimit;
            timerDisplay.textContent = gameState.timeLeft;
            progressBar.style.width = '100%';
            closeGameOverModal();
            startGame();
        }

        // 打开设置
        function openSettings() {
            // 填充当前设置
            difficultySetting.value = gameState.difficulty;
            timeLimitSlider.value = gameState.timeLimit;
            updateTimeValue();
            
            // 勾选当前问题类型
            questionTypeCheckboxes.forEach(checkbox => {
                checkbox.checked = gameState.questionTypes.includes(checkbox.value);
            });
            
            settingsModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 关闭设置
        function closeSettings() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                settingsModal.classList.add('hidden');
            }, 300);
        }

        // 保存设置
        function saveSettings() {
            // 更新难度
            gameState.difficulty = difficultySetting.value;
            difficultyDisplay.textContent = gameState.difficulty.charAt(0).toUpperCase() + gameState.difficulty.slice(1);
            
            // 更新时间限制
            gameState.timeLimit = parseInt(timeLimitSlider.value);
            gameState.timeLeft = gameState.timeLimit;
            timerDisplay.textContent = gameState.timeLeft;
            
            // 更新问题类型
            gameState.questionTypes = Array.from(questionTypeCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
            
            // 如果没有选择任何问题类型，默认选择数学运算
            if (gameState.questionTypes.length === 0) {
                gameState.questionTypes = ['math'];
                document.querySelector('input[name="question-types"][value="math"]').checked = true;
            }
            
            closeSettings();
        }

        // 分享结果
        function shareResult() {
            if (navigator.share) {
                navigator.share({
                    title: '益智题挑战',
                    text: `我在益智题挑战中得了${gameState.score}分！你也来试试吧！`,
                    url: window.location.href
                })
                .catch(error => console.log('分享失败:', error));
            } else {
                alert(`复制此链接分享: ${window.location.href}\n\n你的得分: ${gameState.score}`);
            }
        }

        // 关闭游戏结束模态框
        function closeGameOverModal() {
            gameOverContent.classList.remove('scale-100', 'opacity-100');
            gameOverContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                gameOverModal.classList.add('hidden');
            }, 300);
        }

        // 开始计时器
        function startTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timeLeft = gameState.timeLimit;
            timerDisplay.textContent = gameState.timeLeft;
            progressBar.style.width = '100%';
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                timerDisplay.textContent = gameState.timeLeft;
                const percentage = (gameState.timeLeft / gameState.timeLimit) * 100;
                progressBar.style.width = `${percentage}%`;
                
                // 时间快用完时的视觉提示
                if (gameState.timeLeft <= 10) {
                    timerDisplay.classList.add('text-danger');
                    timerDisplay.classList.add('animate-pulse');
                } else {
                    timerDisplay.classList.remove('text-danger');
                    timerDisplay.classList.remove('animate-pulse');
                }
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    handleWrongAnswer();
                }
            }, 1000);
        }

        // 更新分数显示
        function updateScore() {
            scoreDisplay.textContent = gameState.score;
        }

        // 生成问题
        function generateQuestion() {
            // 随机选择问题类型
            const questionType = gameState.questionTypes[Math.floor(Math.random() * gameState.questionTypes.length)];
            
            // 获取该类型的题目
            const questionsOfType = gameState.questions[questionType] || [];
            
            if (questionsOfType.length === 0) {
                // 如果该类型没有题目，使用默认题目
                const defaultQuestion = {
                    question: "默认问题",
                    answer: "默认答案",
                    options: ["选项1", "选项2", "选项3"]
                };
                
                updateQuestionUI(defaultQuestion, questionType);
                return;
            }
            
            // 确保不重复使用题目
            let availableQuestions = questionsOfType;
            if (gameState.usedQuestions[questionType]) {
                availableQuestions = questionsOfType.filter((_, index) => 
                    !gameState.usedQuestions[questionType].includes(index)
                );
                
                // 如果所有题目都用过了，重置已使用的题目列表
                if (availableQuestions.length === 0) {
                    gameState.usedQuestions[questionType] = [];
                    availableQuestions = questionsOfType;
                }
            } else {
                gameState.usedQuestions[questionType] = [];
            }
            
            // 随机选择一个题目
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const originalIndex = questionsOfType.indexOf(availableQuestions[randomIndex]);
            gameState.usedQuestions[questionType].push(originalIndex);
            
            const questionData = availableQuestions[randomIndex];
            
            // 更新UI
            updateQuestionUI(questionData, questionType);
        }

        // 更新问题UI
        function updateQuestionUI(questionData, questionType) {
            // 更新问题类型指示器
            updateQuestionTypeIndicator(questionType);
            
            // 保存当前问题
            gameState.currentQuestion = {
                ...questionData,
                type: questionType
            };
            
            // 更新UI
            questionDisplay.textContent = questionData.question;
            
            // 根据问题类型决定显示选项还是输入框
            if (questionData.options) {
                // 随机排序选项
                const shuffledOptions = [...questionData.options].sort(() => Math.random() - 0.5);
                
                // 更新选项按钮
                optionButtons.forEach((button, index) => {
                    button.textContent = shuffledOptions[index];
                    button.disabled = false;
                    button.classList.remove('bg-secondary', 'bg-danger', 'opacity-70');
                    button.classList.remove(...Object.values(questionTypeConfig).map(config => config.buttonColor));
                    button.classList.add(questionTypeConfig[questionType].buttonColor);
                });
                
                // 显示选项容器，隐藏输入容器
                optionsContainer.classList.remove('hidden');
                inputAnswerContainer.classList.add('hidden');
            } else {
                // 隐藏选项容器，显示输入容器
                optionsContainer.classList.add('hidden');
                inputAnswerContainer.classList.remove('hidden');
                inputAnswer.value = '';
                inputAnswer.disabled = false;
                submitAnswer.disabled = false;
                inputAnswer.focus();
            }
            
            // 添加问题出现动画
            gameContainer.classList.add('scale-in');
            setTimeout(() => {
                gameContainer.classList.remove('scale-in');
            }, 500);
            
            // 重置反馈
            feedbackDisplay.textContent = '';
        }

        // 更新问题类型指示器
        function updateQuestionTypeIndicator(type) {
            const config = questionTypeConfig[type];
            questionTypeDisplay.textContent = config.name;
            questionTypeDisplay.className = `text-xl font-bold ${config.color}`;
            typeIcon.className = `fa ${config.icon} ${config.color} text-xl mr-2`;
            questionTypeIndicator.className = `bg-white rounded-xl shadow-lg p-3 w-[45%] flex items-center justify-center card-hover ${config.color.replace('text-', 'border-')} border-2`;
        }

        // 检查选项答案
        function checkAnswer(e) {
            if (!gameState.isPlaying) return;
            
            clearInterval(gameState.timerInterval);
            const selectedAnswer = e.target.textContent;
            
            // 禁用所有选项按钮
            optionButtons.forEach(button => {
                button.disabled = true;
                if (button.textContent === gameState.currentQuestion.answer) {
                    button.classList.remove(questionTypeConfig[gameState.currentQuestion.type].buttonColor);
                    button.classList.add('bg-secondary');
                } else if (button === e.target) {
                    button.classList.remove(questionTypeConfig[gameState.currentQuestion.type].buttonColor);
                    button.classList.add('bg-danger');
                } else {
                    button.classList.add('opacity-70');
                }
            });
            
            // 判断答案是否正确
            if (selectedAnswer === gameState.currentQuestion.answer) {
                handleCorrectAnswer();
            } else {
                handleWrongAnswer();
            }
        }

        // 检查输入答案
        function checkInputAnswer() {
            if (!gameState.isPlaying || !inputAnswer.value.trim()) return;
            
            clearInterval(gameState.timerInterval);
            const userAnswer = inputAnswer.value.trim().toLowerCase();
            
            // 判断答案是否正确（考虑一些常见的同义表达）
            if (userAnswer === gameState.currentQuestion.answer.toLowerCase() ||
                (gameState.currentQuestion.answer.includes("或") && 
                 gameState.currentQuestion.answer.toLowerCase().split("或").some(ans => userAnswer === ans.trim()))) {
                handleCorrectAnswer();
            } else {
                handleWrongAnswer();
            }
            
            // 禁用输入和提交按钮
            inputAnswer.disabled = true;
            submitAnswer.disabled = true;
        }

        // 处理正确答案
        function handleCorrectAnswer() {
            gameState.score += 10 + gameState.timeLeft; // 得分基于剩余时间
            gameState.correctAnswers++;
            updateScore();
            
            feedbackDisplay.textContent = "正确！";
            feedbackDisplay.className = "text-center h-10 mb-4 text-secondary font-bold fade-in";
            
            // 延迟生成下一题
            setTimeout(() => {
                inputAnswer.disabled = false;
                submitAnswer.disabled = false;
                generateQuestion();
                startTimer();
            }, 1000);
        }

        // 处理错误答案
        function handleWrongAnswer() {
            gameState.wrongAnswers++;
            
            feedbackDisplay.textContent = `错误！正确答案是: ${gameState.currentQuestion.answer}`;
            feedbackDisplay.className = "text-center h-10 mb-4 text-danger font-bold fade-in";
            
            // 如果错误次数达到3次，游戏结束
            if (gameState.wrongAnswers >= 3) {
                endGame();
            } else {
                // 延迟生成下一题
                setTimeout(() => {
                    inputAnswer.disabled = false;
                    submitAnswer.disabled = false;
                    generateQuestion();
                    startTimer();
                }, 2000);
            }
        }

        // 结束游戏
        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.timerInterval);
            
            // 更新游戏结束模态框
            finalScoreDisplay.textContent = gameState.score;
            correctAnswersDisplay.textContent = gameState.correctAnswers;
            wrongAnswersDisplay.textContent = gameState.wrongAnswers;
            
            // 保存分数
            saveScore();
            
            // 显示游戏结束模态框
            gameOverModal.classList.remove('hidden');
            setTimeout(() => {
                gameOverContent.classList.remove('scale-95', 'opacity-0');
                gameOverContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // 重置按钮状态
            startBtn.classList.remove('hidden');
            restartBtn.classList.add('hidden');
        }

        // 打开排行榜
        function openLeaderboard() {
            updateLeaderboardDisplay();
            leaderboardModal.classList.remove('hidden');
            setTimeout(() => {
                leaderboardContent.classList.remove('scale-95', 'opacity-0');
                leaderboardContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 关闭排行榜
        function closeLeaderboard() {
            leaderboardContent.classList.remove('scale-100', 'opacity-100');
            leaderboardContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                leaderboardModal.classList.add('hidden');
            }, 300);
        }

        // 打开玩家名称输入框
        function openPlayerNameModal() {
            // 如果已有名字，填充输入框
            if (leaderboardState.playerName) {
                playerNameInput.value = leaderboardState.playerName;
            } else {
                // 生成一个默认名字
                const defaultNames = ['智慧之星', '解题高手', '脑力达人', 'puzzle大师', '思维王者'];
                playerNameInput.value = defaultNames[Math.floor(Math.random() * defaultNames.length)];
            }
            
            playerNameModal.classList.remove('hidden');
            setTimeout(() => {
                nameModalContent.classList.remove('scale-95', 'opacity-0');
                nameModalContent.classList.add('scale-100', 'opacity-100');
                playerNameInput.focus();
            }, 10);
        }

        // 关闭玩家名称输入框
        function closePlayerNameModal() {
            nameModalContent.classList.remove('scale-100', 'opacity-100');
            nameModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                playerNameModal.classList.add('hidden');
            }, 300);
        }

        // 保存玩家名称
        function savePlayerName() {
            const name = playerNameInput.value.trim() || '匿名玩家';
            leaderboardState.playerName = name;
            localStorage.setItem('puzzleGamePlayerName', name);
            closePlayerNameModal();
            
            // 如果是游戏结束后保存名字，保存分数
            if (gameState.isPlaying === false && gameState.score > 0) {
                saveScore();
            }
        }

        // 保存分数到排行榜
        function saveScore() {
            // 如果没有玩家名称，提示输入
            if (!leaderboardState.playerName) {
                openPlayerNameModal();
                return;
            }
            
            // 添加新分数
            const newScore = {
                name: leaderboardState.playerName,
                score: gameState.score,
                correct: gameState.correctAnswers,
                date: new Date().toISOString()
            };
            
            leaderboardState.scores.push(newScore);
            
            // 只保留前10名高分
            leaderboardState.scores.sort((a, b) => b.score - a.score);
            if (leaderboardState.scores.length > 10) {
                leaderboardState.scores = leaderboardState.scores.slice(0, 10);
            }
            
            // 保存到localStorage
            localStorage.setItem('puzzleGameScores', JSON.stringify(leaderboardState.scores));
            
            // 更新排行榜显示
            updateLeaderboardDisplay();
        }

        // 更新排行榜显示
        function updateLeaderboardDisplay() {
            leaderboardList.innerHTML = '';
            
            if (leaderboardState.scores.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'text-center py-8 text-gray-500';
                emptyItem.innerHTML = '<i class="fa fa-trophy text-3xl mb-2 text-gray-300"></i><p>暂无记录，快来挑战吧！</p>';
                leaderboardList.appendChild(emptyItem);
                return;
            }
            
            // 显示排行榜
            leaderboardState.scores.forEach((entry, index) => {
                const date = new Date(entry.date);
                const formattedDate = `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                const listItem = document.createElement('div');
                listItem.className = `flex items-center p-3 rounded-lg ${index < 3 ? 'bg-primary/5' : 'bg-gray-50'}`;
                
                // 排名样式（前三名有特殊样式）
                let rankStyle = '';
                let medalIcon = '';
                
                if (index === 0) {
                    rankStyle = 'bg-yellow-500 text-white';
                    medalIcon = '<i class="fa fa-trophy text-yellow-500 ml-2"></i>';
                } else if (index === 1) {
                    rankStyle = 'bg-gray-400 text-white';
                    medalIcon = '<i class="fa fa-trophy text-gray-400 ml-2"></i>';
                } else if (index === 2) {
                    rankStyle = 'bg-amber-700 text-white';
                    medalIcon = '<i class="fa fa-trophy text-amber-700 ml-2"></i>';
                } else {
                    rankStyle = 'bg-gray-200 text-gray-700';
                }
                
                listItem.innerHTML = `
                    <div class="w-8 h-8 rounded-full ${rankStyle} flex items-center justify-center font-bold mr-3">
                        ${index + 1}
                    </div>
                    <div class="flex-grow">
                        <div class="font-medium">${entry.name} ${medalIcon}</div>
                        <div class="text-sm text-gray-500">答对 ${entry.correct} 题 · ${formattedDate}</div>
                    </div>
                    <div class="font-bold text-primary text-xl">${entry.score}</div>
                `;
                
                leaderboardList.appendChild(listItem);
            });
        }

        // 清空排行榜
        function clearLeaderboard() {
            if (confirm('确定要清空所有排行榜记录吗？此操作不可恢复。')) {
                leaderboardState.scores = [];
                localStorage.removeItem('puzzleGameScores');
                updateLeaderboardDisplay();
            }
        }

        // 初始化游戏
        async function initGame() {
            initEventListeners();
            difficultyDisplay.textContent = gameState.difficulty.charAt(0).toUpperCase() + gameState.difficulty.slice(1);
            timerDisplay.textContent = gameState.timeLimit;
            
            // 加载题库
            await loadQuestions();
            
            // 初始化排行榜显示
            updateLeaderboardDisplay();
        }

        // 页面加载完成后初始化游戏
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>    
